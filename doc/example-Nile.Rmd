# Example Models

## Nile

This is a short ($n = 100$) univariate time series of the annual flow volumes of
the Nile River at Aswan between 1871 and 1970. 
This series is described in @DurbinKoopman2012 and had been analyzed by @Cobb1978 and @Balke1993, and in numerous time series textbooks.
A notable feature of the series is a seeming structural break in 1899, around the time of the completion of the Aswan dam.

```{r Nile}
data("Nile", package = "datasets")
Nile_ <- data_frame(year = year(as.Date(Nile)),
                    flow = as.numeric(Nile))
```

```{r Nile_plot}
ggplot(Nile_, aes(x = year, y = flow)) +
  geom_point() +
  geom_line() +
  ylab("Annual Flow") + xlab("")
```

### Local Level Model

The Nile data can be modeled as a local level model,
$$
\begin{aligned}[t]
y_t &= \mu_t + \varepsilon_t & \varepsilon_t & \sim N(0, \sigma_{\varepsilon}^2) \\
\mu_{t + 1} &= \mu_t + \eta_t &
\eta_t & \sim N(0, \sigma^2_{\eta})
\end{aligned}
$$

```{r engine = 'cat', file = system.file("stan/models/local_level.stan", package = "StanStateSpace"), lang = 'stan'}
```

```{r Nile-Model, message=FALSE, warning=FALSE, eval=FALSE}
STAN_SSM_MODELS <- system.file("stan/models", package = "StanStateSpace")
STAN_SSM_INCLUDE <- system.file("stan/include", package = "StanStateSpace")
local_level_code <-
  stanc_builder(file.path(STAN_SSM_MODELS, "local_level.stan"),
                isystem = STAN_SSM_INCLUDE)
local_level_mod <- stan_model(model_code = local_level_code[["model_code"]],
                              model_name = local_level_code[["model_name"]])
```

```{r Nile-Local-Level-Sampling, eval = FALSE}
nile_data <- within(list(), {
  y <- matrix(Nile_$flow)
  n <- nrow(y)
  a1 <- array(0, 1)
  P1 <- matrix(10 ^ 7)
  y_scale <- sd(Nile_$flow)
})
nile_1_samples <- 
  sampling(local_level_mod,
                          chains = 1,
                          iter = 500,
                          data = nile_data)
nile_1_summary <- summary(nile_1_samples)
```

```{r}
summary(nile_1_samples, par = c("H", "Q"))[["summary"]]
```
which is similar to the MLE results ,
```{r}
StructTS(Nile_$flow, type = "level")
```

```{r}
nile_1_filter <- ssm_extract_summary(nile_1_summary, "filtered", 1, 1)
ggplot(dplyr::filter(nile_1_filter, parameter == "a[1]", time > 1),
       aes(x = time, y = mean, 
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_ribbon(alpha = 0.3) +
  geom_line()

```

```{r}
ggplot(dplyr::filter(nile_1_filter, parameter == "P[1,1]", time > 1),
       aes(x = time, y = mean, 
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_ribbon(alpha = 0.3) +
  geom_line()

```


```{r nile_1_states}
str_keep <- function(string, pattern) {
  string[str_detect(string, pattern)]
}

nile_1_states <-
  as_data_frame(nile_1_summary[["summary"]]) %>%
  mutate(par_id = rownames(nile_1_summary[["summary"]])) %>%
  inner_join(
    `colnames<-`(as_data_frame(str_match(str_keep(rownames(nile_1_summary[["summary"]]), "^alpha\\["), "^alpha\\[(\\d+),(\\d+)\\]")), c("par_id", "time", "index")),
    by = "par_id"
  ) %>%
  mutate(time = as.integer(time), index = as.integer(index))

ggplot(dplyr::filter(nile_1_states, index == 1),
       aes(x = time, y = mean,
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_ribbon(alpha = 0.3) +
  geom_line()

```

```{r nile_1_eps}
nile_1_eps <-
  as_data_frame(nile_1_summary[["summary"]]) %>%
  mutate(par_id = rownames(nile_1_summary[["summary"]])) %>%
  inner_join(
    `colnames<-`(as_data_frame(str_match(str_keep(rownames(nile_1_summary[["summary"]]), "^eps\\["), "^eps\\[(\\d+),(\\d+)\\]")), c("par_id", "time", "index")),
    by = "par_id"
  ) %>%
  mutate(time = as.integer(time), index = as.integer(index))

ggplot(dplyr::filter(nile_1_eps, index == 1),
       aes(x = time, y = mean, 
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_pointrange()

```

```{r nile_1_eta}
nile_1_eta <-
  as_data_frame(nile_1_summary[["summary"]]) %>%
  mutate(par_id = rownames(nile_1_summary[["summary"]])) %>%
  inner_join(
    `colnames<-`(as_data_frame(str_match(str_keep(rownames(nile_1_summary[["summary"]]), "^eta\\["), "^eta\\[(\\d+),(\\d+)\\]")), c("par_id", "time", "index")),
    by = "par_id"
  ) %>%
  mutate(time = as.integer(time), index = as.integer(index))

ggplot(dplyr::filter(nile_1_eta, index == 1),
       aes(x = time, y = mean, 
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_pointrange()

```


```{r nile_1_eps}
nile_1_eps <-
  as_data_frame(nile_1_summary[["summary"]]) %>%
  mutate(par_id = rownames(nile_1_summary[["summary"]])) %>%
  inner_join(
    `colnames<-`(as_data_frame(str_match(str_keep(rownames(nile_1_summary[["summary"]]), "^eps\\["), "^eps\\[(\\d+),(\\d+)\\]")), c("par_id", "time", "index")),
    by = "par_id"
  ) %>%
  mutate(time = as.integer(time), index = as.integer(index))

ggplot(dplyr::filter(nile_1_eps, index == 1),
       aes(x = time, y = mean, 
           ymin = mean - 2 * sd,
           ymax = mean + 2 * sd)) +
  geom_pointrange()

```

## Nile with intervention (covariate)





## Nile with intervention (variance)
