# Example Models

## Nile

This is a short ($n = 100$) univariate time series of the annual flow volumes of
the Nile River at Aswan between 1871 and 1970. This series is described in
@DurbinKoopman2012 and had been analyzed by @Cobb1978 and @Balke1993. It is
included with R as the dataset `Nile`.

```{r Nile} 
data("Nile", package = "datasets") 
Nile_ <- data_frame(year = year(ts_to_date(time(Nile))),
                    flow = as.numeric(Nile))
```

```{r Nile_plot} 
ggplot(Nile_, aes(x = year, y = flow)) + 
  geom_point() + 
  geom_line() + 
  ylab("Annual Flow") + xlab("")
```

### Local Level Model

The Nile data can be modeled as a local level model,
$$
\begin{aligned}[t] 
y_t &= \mu_t + \varepsilon_t & \varepsilon_t & \sim N(0, \sigma_{\varepsilon}^2) \\ 
\mu_{t + 1} &= \mu_t + \eta_t & 
\eta_t & \sim N(0, \sigma^2_{\eta}) 
\end{aligned} 
$$ 
This is a time-invariant SSM with $m = 1$ states, $p = 1$
observations at each time period, and $r = 1$ system disturbances, 
$$ 
\begin{aligned}[t] 
\mat{T} = \mat{Z} = \mat{R} &= \begin{bmatrix} 1 \end{bmatrix} \\ 
\mat{c} = \mat{Q} &= \begin{bmatrix} 0 \end{bmatrix} \\ 
\mat{H} &= \begin{bmatrix} \sigma_{\varepsilon}^2 \end{bmatrix} \\
\mat{Q} &= \begin{bmatrix} \sigma_{\eta}^2 \end{bmatrix}
\end{aligned}
$$

```{r Nile-StructTS}
StructTS(Nile, type = "level")
```


```{r}
local_level_code <- stanc_builder("stan/local_level.stan")
rm(local_level_mod)
local_level_mod <- stan_model(model_code = local_level_code[["model_code"]],
                              model_name = local_level_code[["model_name"]])


```

```{r nile_local_level_sampling}
nile_data <- within(list(), {
  y <- matrix(Nile_$flow)
  n <- nrow(y)
  a1 <- array(0, 1)
  P1 <- matrix(10 ^ 7)
})
nile_init <- list(list(sigma_epsilon = sqrt(15099),
                       sigma_eta = sqrt(1469)))
nile_ll_sample <- sampling(local_level_mod,
                         chains = 1,
                         iter = 2000,
                         data = nile_data)
summary(nile_ll_sample, c("sigma_eta", "sigma_epsilon"))[[1]]

```

```{r nile_local_level_optim}
nile_ll_optim <- optimizing(local_level_mod, data = nile_data,
                            init = list(sigma_eta = 5,
                                        sigma_epsilon = 100))
nile_ll_optim$par[c("sigma_eta", "sigma_epsilon")]
```


## Airline Passenger Miles

Monthly totals of international airline passengers, 1949 to 1960, used in the
Box-Jenkins textbook [@BoxJenkinsReinsel1994]. This data is included with R as
the dataset `AirPassengers`.

```{r AirPassengers} 
data("AirPassengers", package = "datasets") 
AirPassengers_ <- tbl_df(as.data.frame(AirPassengers)) %>%
  mutate(date = ts_to_date(time(AirPassengers))) %>%
  select(date, everything()) %>% 
  mutate(x = as.numeric(x)) %>%
  rename(passengers = x) %>%
  mutate(log_passengers = log10(passengers))
```

```{r AirPassengers_plot} 
ggplot(AirPassengers_, aes(x = date, y = passengers)) + 
  geom_point() + 
  geom_line() + 
  scale_y_continuous("Number") + xlab("")
```

See help for `AirPassengers` in R for example models. SARIMA (0, 1, 1) (0, 1, 1)
as in Box-Jenkins 
```{r AirPassengers-arima} 
arima(log10(AirPassengers), c(0, 1, 1), 
      seasonal = list(order = c(0, 1, 1), period = 12)) 
```

## Structural Time Series Model

```{r AirPassengers-StructTS} 
StructTS(log10(AirPassengers), type = "BSM")
```

```{r}
var_only_code <- stanc_builder("stan/var_only.stan")
rm(var_only_mod)
var_only_mod <- stan_model(model_code = var_only_code[["model_code"]],
                              model_name = var_only_code[["model_name"]])

```

```{r}
airlines_data <- within(list(), {
  y <- matrix(log10(as.numeric(AirPassengers))) - 2
  n <- length(y)
  p <- 1
  r <- 3
  m <- 13
  T_lvls <- as.numeric(upper.tri(matrix(0, 2, 2), diag = TRUE))
  T_seas <- rbind(rep(-1, 11), diag(1, 10, 11))
  T <- matrix(0, 13, 13)
  T[1:2, 1:2] <- T_lvls
  T[3:13, 3:13] <- T_seas
  Z <- matrix(c(c(1, 0, 1), rep(0, 10)), 1, 13)
  R <- rbind(matrix(c(1, 0, 0,
                      0, 1, 0,
                      0, 0, 1), 3, 3),
             matrix(0, 10, 3))
  d <- array(0, 1)
  c <- rep(0, m)
  a1 <- rep(0, m)
  P1 <- diag(1e6, m, m) * var(y)
})
airlines_init <- list(sigma_eta = c(0.01206565, 2e-06, 0.01623185),
                      sigma_epsilon = 1e-06)
airlines_ll_sample <- sampling(var_only_mod,
                         chains = 1,
                         iter = 500,
                         init = list(airlines_init),
                         data = airlines_data, verbose = TRUE)
summary(airlines_ll_sample, c("sigma_eta", "sigma_epsilon"))[[1]]
```

```{r}
airlines_optim <- 
  rstan::optimizing(var_only_mod,
                   init = airlines_init,
                   data = airlines_data,
                   as_vector = FALSE,
                   verbose = TRUE)
airlines_optim$par[c("sigma_eta", "sigma_epsilon")]
```







## Road Casualties in Great Britain

Monthly totals of car drivers in Great Britain killed or seriously injured
January 1969 to December 1984. The compulsory wearing of seat belts was
introducted on January 31, 1983. These data were analyzed in @HarveyDurbin1986,
and used as an example in @DurbinKoopman2012, @Harvey1993a, and
@CommandeurKoopman2007.

This data is included in R with the dataset `Seatbelts`.

```{r Seatbelts} 
data("Seatbelts", package = "datasets")
Seatbelts_ <- tbl_df(as.data.frame(Seatbelts)) %>% 
  mutate(date = ts_to_date(time(Seatbelts))) %>%
  select(date, everything())
```

```{r Seatbelts-plot} 
ggplot(Seatbelts_, aes(x = date, y = DriversKilled)) + 
  geom_point() +
  geom_line() +
  ylab("Number") +
  xlab("")
```

StructTS Models of Seatbelts 
```{r Seatbelts-StructTS} 
StructTS(Seatbelts[ , "DriversKilled"], type = "level")
StructTS(Seatbelts[ , "DriversKilled"], type = "trend") 
StructTS(Seatbelts[ , "DriversKilled"], type = "BSM")
```

## Local Level Model

```{r seatbelts_ll}
seatbelts_data <- within(list(), {
  y <- matrix(log10(Seatbelts_$DriversKilled))
  n <- length(y)
  p <- 1
  r <- 1
  m <- 1
  T <- matrix(1)
  Z <- matrix(1)
  R <- matrix(1)
  d <- array(0, 1)
  c <- array(rep(0, m))
  a1 <- array(rep(0, m))
  P1 <- diag(1e6, m, m) * var(as.numeric(y))
})
# seatbelts_local_lvl_init <- list(sigma_eta = c(6.02, 1e-6, .02),
#                                  sigma_epsilon = .04)
seatbelts_local_lvl_sample <- sampling(var_only_mod,
                         chains = 1,
                         iter = 500,
                         init = 0,
                         data = seatbelts_data, verbose = TRUE)
summary(seatbelts_local_lvl_sample, c("sigma_eta", "sigma_epsilon"))[[1]]
```

```{r}

# ssm_gen_extractor(loglik = list(dim = 1))
gen_ssm_extractor <- function(...) {
  params <- list(...)
  ret <- list()
  start <- 0
  for (i in seq_along(params)) {
    x <- params[[i]]
    len <- prod(x)
    ret[[names(params)[i]]] <- 
      list(start = start + 1,
           end = start + len,
           len = len,
           dim = x)
    start <- start + len
  }
  ret
}

gen_ssm_filter_extractor <- function(m, p) {
  gen_ssm_extractor(loglik = 1,
                    v = p,
                    Finv = c(p, p),
                    K = c(m, p),
                    a = m,
                    P = c(m, m))
}


extract_ssm_filter_values <- function(x, m, p, params = NULL) {
  f <- function(x, extractor) {
    g <- function(x, el) {
      .n <- nrow(x)
      array(t(x[ , el[["start"]]:el[["end"]]]), c(el[["dim"]], .n))
    }
    map(extractor, ~ g(x, .x))
  }
  extractor <- gen_ssm_filter_extractor(m, p)
  if (!is.null(params)) {
    extractor <- extractor[params]
  }
  map(array_tree(x, 1), ~ f(.x, extractor))
}

```


## Basic Structural Model (Trend, Seasonal)




```{r}
seatbelts_data <- within(list(), {
  y <- matrix(log10(Seatbelts_$DriversKilled))
  n <- length(y)
  p <- 1
  r <- 3
  m <- 13
  T_lvls <- as.numeric(upper.tri(matrix(0, 2, 2), diag = TRUE))
  T_seas <- rbind(rep(-1, 11), diag(1, 10, 11))
  T <- matrix(0, 13, 13)
  T[1:2, 1:2] <- T_lvls
  T[3:13, 3:13] <- T_seas
  Z <- matrix(c(c(1, 0, 1), rep(0, 10)), 1, 13)
  R <- rbind(matrix(c(1, 0, 0,
                      0, 1, 0,
                      0, 0, 1), 3, 3),
             matrix(0, 10, 3))
  d <- array(0, 1)
  c <- rep(0, m)
  a1 <- rep(0, m)
  P1 <- diag(1e6, m, m) * var(as.numeric(y))
})
seatbelts_init <- list(sigma_eta = c(6.02, 1e-6, .02),
                      sigma_epsilon = .04)
seatbelts_ll_sample <- sampling(var_only_mod,
                         chains = 1,
                         iter = 500,
                         init = list(seatbelts_init),
                         data = seatbelts_data, verbose = TRUE)
summary(seatbelts_ll_sample, c("sigma_eta", "sigma_epsilon"))[[1]]
```

```{r}
seatbelts_optim <- 
  rstan::optimizing(var_only_mod,
                   init = seatbelts_init,
                   data = seatbelts_data,
                   as_vector = FALSE,
                   verbose = TRUE)
seatbelts_optim$par[c("sigma_eta", "sigma_epsilon")]
```



SARIMA (1, 0, 0) (1, 0, 0) \
```{r Seatbelts-arima}
arima(Seatbelts[ , "DriversKilled"], c(1, 0, 0), seasonal = list(order = c(1, 0, 0))) 
```

SARIMA with covariates 
```{r Seatbelts-arimax} 
X <- Seatbelts[, c("kms", "PetrolPrice", "law")] 
X[, 1] <- log10(X[, 1]) - 4 
arima(log10(Seatbelts[, "drivers"]), c(1, 0, 0),
      seasonal = list(order = c(1, 0, 0)), xreg = X) 
```

## UK Quarterly Gas Consumption

Quarterly UK gas consumption from 1960 to 1986 in millions of therms. 
These data are used as an example in @DurbinKoopman2012,
and included in R as a dataset `UKgas`.

```{r UKgas}
UKgas_ <- data_frame(date = ts_to_date(time(UKgas)),
                     therms = as.numeric(UKgas))
```

```{r UKgas-plot}
ggplot(UKgas_, aes(x = date, y = therms)) +
  geom_point() +
  geom_line() +
  scale_y_log10("log10(therms)") +
  scale_x_date(date_breaks = "5 years", date_labels = "%Y") +
  xlab("")
```

```{r}
seatbelts_data <- within(list(), {
  y <- matrix(log10(Seatbelts_$DriversKilled))
  n <- length(y)
  p <- 1
  r <- 3
  m <- 13
  T_lvls <- as.numeric(upper.tri(matrix(0, 2, 2), diag = TRUE))
  T_seas <- rbind(rep(-1, 11), diag(1, 10, 11))
  T <- matrix(0, 13, 13)
  T[1:2, 1:2] <- T_lvls
  T[3:13, 3:13] <- T_seas
  Z <- matrix(c(c(1, 0, 1), rep(0, 10)), 1, 13)
  R <- rbind(matrix(c(1, 0, 0,
                      0, 1, 0,
                      0, 0, 1), 3, 3),
             matrix(0, 10, 3))
  d <- array(0, 1)
  c <- rep(0, m)
  a1 <- rep(0, m)
  P1 <- diag(1e6, m, m) * var(as.numeric(y))
})
seatbelts_init <- list(sigma_eta = c(6.02, 1e-6, .02),
                      sigma_epsilon = .04)
seatbelts_ll_sample <-
  sampling(var_only_mod,
           chains = 1,
           iter = 500,
           init = list(seatbelts_init),
           data = seatbelts_data, verbose = TRUE)
summary(seatbelts_ll_sample, c("sigma_eta", "sigma_epsilon"))[[1]]
```

## Stata 

Stata state space model examples from [State Time SEries Refence3 Manual, Release 14](http://www.stata.com/manuals14/ts.pdf) functions `sspace`, `arima`, `dfactor`, and `ucm`. 

These examples are also used in the Python StatsModels module [statsmodels.tsa.statespace](http://www.statsmodels.org/dev/statespace.html).

**TODO**

#### Ex 1: An AR(1) model

An AR(1) model,
$$
y - \mu = \phi(y_{t - 1} - \mu) + \varepsilon_t
$$
can be written in state space form as,
$$
\begin{aligned}[t]
y_t &= \mu + \alpha_t \\
\alpha_{t + 1} &= \phi \alpha_t + \varepsilon_t
\end{aligned}
$$
where the state is $\alpha_t = y_t - \mu$.

Fit the first difference of the natural log of the capacity utilization rate
for the manufacturing section of the U.S. economy.
This model treats the series as first-difference stationary, and models its first
difference as an AR(1) process.

This is the stata dataset `manufac`, variable `lncaputil`.

#### Ex 2: An ARMA (1, 1) model

A zero-mean, first-order, autoregressive moving-average process (ARMA(1, 1)) model,
$$
y_t = \phi y_{t - 1} + \theta \varepsilon_{t - 1} + \varepsilon_t
$$
can be written as a state space model,
$$
\begin{aligned}[t]
y_t &= \mu + \begin{bmatrix} 1 & 0 \end{bmatrix} \vec{\alpha}_t \\
\vec{\alpha}_{t + 1} &=
\begin{bmatrix}
\phi & 1 \\
0 & 0
\end{bmatrix}
\vec{\alpha}_t
+
\begin{bmatrix}
1 \\
\theta
\end{bmatrix}
\varepsilon_t
&
\varepsilon_t
& \sim N(0, \sigma^2 \varepsilon)
\end{aligned}
$$
where there state vector is $\vec{\alpha}_t = (y_t, \theta \varepsilon_t)$

This also uses the `manufac` dataset, and variable `lncaputil`.


## Other Sources

- @PetrisPetrone2011a - Nile: local level - UKGas: Structural: local trend +
seasonal factor - Industrial Production of consumer goods: local trend, outliers
and structural breaks.

- @Petris2010a

- Temperuratures: dlm dynamic factor - Nile: local level

- @Tusell2011 - @CommandeurKoopman2007 - @DurbinKoopman2012 - KFAS -
@ShumwayStoffer2010
