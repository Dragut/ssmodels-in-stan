# Example Models



## Nile

This is a short ($n = 100$) univariate time series of the annual flow volumes of
the Nile River at Aswan between 1871 and 1970. 
This series is described in @DurbinKoopman2012 and had been analyzed by @Cobb1978 and @Balke1993, and in numerous time series textbooks.
A notable feature of the series is a seeming structural break in 1899, around the time of the completion of the Aswan dam.
<!-- It is included with R as the dataset `Nile`. -->


```{r Nile}
data("Nile", package = "datasets")
Nile_ <- data_frame(year = year(as.Date(Nile)),
                    flow = as.numeric(Nile))
```

```{r Nile_plot}
ggplot(Nile_, aes(x = year, y = flow)) +
  geom_point() +
  geom_line() +
  ylab("Annual Flow") + xlab("")
```

### Local Level Model

The Nile data can be modeled as a local level model,
$$
\begin{aligned}[t]
y_t &= \mu_t + \varepsilon_t & \varepsilon_t & \sim N(0, \sigma_{\varepsilon}^2) \\
\mu_{t + 1} &= \mu_t + \eta_t &
\eta_t & \sim N(0, \sigma^2_{\eta})
\end{aligned}
$$
This is a time-invariant SSM with $m = 1$ states, $p = 1$
observations at each time period, and $r = 1$ system disturbances,
$$
\begin{aligned}[t]
\mat{T} = \mat{Z} = \mat{R} &= \begin{bmatrix} 1 \end{bmatrix} \\
\mat{c} = \mat{Q} &= \begin{bmatrix} 0 \end{bmatrix} \\
\mat{H} &= \begin{bmatrix} \sigma_{\varepsilon}^2 \end{bmatrix} \\
\mat{Q} &= \begin{bmatrix} \sigma_{\eta}^2 \end{bmatrix}
\end{aligned}
$$

```{r engine = 'cat', file = '../stan/local_level.stan', lang = 'stan'}
```

```{r Nile-Model, message=FALSE, warning=FALSE}
devtools::install("StanStateSpace")
STAN_SSM_MODELS <- system.file("stan/models", package = "StanStateSpace")
STAN_SSM_INCLUDE <- system.file("stan/include", package = "StanStateSpace")
local_level_code <-
  stanc_builder(file.path(STAN_SSM_MODELS, "local_level.stan"),
                isystem = STAN_SSM_INCLUDE)
local_level_mod <- stan_model(model_code = local_level_code[["model_code"]],
                              model_name = local_level_code[["model_name"]])
```

```{r Nile-Local-Level-Sampling}
nile_data <- within(list(), {
  y <- matrix(Nile_$flow)
  n <- nrow(y)
  a1 <- array(0, 1)
  P1 <- matrix(10 ^ 7)
})
nile_ll_sample <- sampling(local_level_mod,
                          chains = 4,
                          iter = 1000,
                          data = nile_data)
```

```{r Nile-Summary}
summary(nile_ll_sample, c("sigma_epsilon", "sigma_eta"))[[1]]
summary(nile_ll_sample, c("H", "Q"))[[1]]
```

```{r Nile-StructTS}
StructTS(Nile, type = "level")
```

In the `generated quantities` block various outputs of filters, smoothers, and simulations are calculated.

The expected value of the predicted states, $\E(a_t)$,
```{r Nile-predicted-states-a}
nile_filtered_params <-
  extract_from_ssm_filter(rstan::extract(nile_ll_sample, "filtered")[[1]], 1, 1)
ggplot(slice(mutate(Nile_, state = apply(nile_params[["a"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_point(aes(y = flow)) + 
  geom_line(aes(y = state))
```
the expected value of the predicted state variances, $\E(P_t)$,
```{r Nile-smoothed-states-P}
ggplot(slice(mutate(Nile_, state = apply(nile_params[["P"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_line(aes(y = state))
```
the expected value of the Kalman gains, $\E(K_t)$,
```{r Nile-smoothed-states-K}
ggplot(slice(mutate(Nile_, state = apply(nile_params[["K"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_line(aes(y = state))
```
the expected value of the forecast errors, $\E(v_t)$,
```{r Nile-smoothed-states-K}
ggplot(slice(mutate(Nile_, state = apply(nile_params[["v"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_hline(yintercept = 0) +
  geom_point(aes(y = state)) +
  geom_line(aes(y = state))
```
the expected value of the forecast precision, $\E(Finv_t)$,
```{r Nile-smoothed-states-K}
ggplot(slice(mutate(Nile_, state = apply(nile_params[["Finv"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_point(aes(y = state)) +
  geom_line(aes(y = state))
```


The results of smoothers,

The expected value of the predicted states, $\E(a_t)$,
```{r Nile-predicted-states-a}
nile_filtered_params <-
  extract_from_ssm_filter(rstan::extract(nile_ll_sample, "alpha")[[1]], 1, 1)
ggplot(slice(mutate(Nile_, state = apply(nile_params[["a"]], 2:3, mean)), 2:n()),
              aes(x = year)) +
  geom_point(aes(y = flow)) + 
  geom_line(aes(y = state))
```



```{r Nile-local-level-optimization}
nile_ll_optim <- optimizing(local_level_mod, data = nile_data,
                            init = list(sigma_eta = sd(Nile),
                                        sigma_epsilon = sd(Nile)))
nile_ll_optim$par[c("sigma_eta", "sigma_epsilon")]
```


